@model AliMartinCv.DataLayer.DTos.ShowClassStudentsViewModel
@using AliMartinCv.DataLayer.Entities
@{
    Layout = "/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "Schools";
    int rowNumber = 1;
}
<style>
    .container-fluid {
    padding: 20px;
}
.btn-user {
    margin-right: 5px;
}
.table-responsive {
    margin-top: 20px;
}
/* استایل‌های مودال فانتزی */
.random-modal .modal-content {
    background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
    color: white;
    border-radius: 15px;
    text-align: center;
    padding: 30px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    text-align: center;
}
.random-modal .modal-header {
    border-bottom: none;
}
.random-modal .modal-title {
    font-size: 7rem;
    font-weight: bold;
    text-align: center!important;
    color: whitesmoke!important;
}
.random-modal .modal-body {
    font-size: 1.5rem;
}
.countdown {
    font-size: 8rem;
    font-weight: bold;
    color: #fff;
    text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4);
    animation: pulse 0.8s ease-in-out infinite;
}
.student-info {
    display: none;
    font-size: 5.5rem;
    font-weight: bolder;
    margin-top: 30px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}
@@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}
.fade-in {
    animation: fadeIn 0.5s ease-in;
}
@@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
</style>
<div class="container-fluid">
    <h1 class="h3 mb-2 text-gray-800 fw-bolder">@Model.ClassName Students</h1>
    <hr />
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Class @Model.ClassName Students</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <div id="dataTable_wrapper" class="dataTables_wrapper dt-bootstrap4">
                    <div class="row">
                        <div class="col-sm-12 col-md-4">
                            <a class="btn btn-success btn-sm btn-user" href="/Admin/Students/createstudent/@Model.ClassId">Add New Student</a>
                        </div>
                        <div class="col-sm-12 col-md-4">
                            <a class="btn btn-info btn-sm btn-user" href="/Admin/attendances/index/@Model.ClassId">Attendance</a>
                        </div>
                        <div class="col-sm-12 col-md-4 text-right">
                            <div id="dataTable_filter" class="dataTables_filter">
                                <label>
                                    <input type="text" id="searchInput" class="form-control form-control-sm" onkeyup="searchSchools()" placeholder="Search by name" aria-controls="dataTable">
                                </label>
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-4">
                            <button type="button" class="btn btn-primary btn-sm btn-user" onclick="selectRandomStudent()">Select Random Student</button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-12">
                            <table class="table table-bordered dataTable" id="dataTable" width="100%" cellspacing="0" role="grid" aria-describedby="dataTable_info" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Row</th>
                                        <th>Name</th>
                                        <th>LastName</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="schoolsTableBody">
                                    @foreach (var student in Model.Students)
                                    {
                                        <tr class="odd">
                                            <td class="sorting_1">@rowNumber</td>
                                            <td class="sorting_1">@student.Name</td>
                                            <td class="sorting_1">@student.LastName</td>
                                            <td>
                                                <a href="/Admin/Classes/CreateClass/@student.ClassId" class="btn btn-sm btn-primary btn-user">Add Class</a>
                                                <a href="/Admin/Students/EditStudent/@student.StudentId" class="btn btn-sm btn-warning btn-user">Edit</a>
                                                <a href="#" class="btn btn-sm btn-danger btn-user" onclick="confirmDelete('@student.StudentId')">Delete</a>
                                            </td>
                                        </tr>
                                        rowNumber++;
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div>
    <a href="/admin/schools">Back to List</a>
</div>

<!-- Modal for Delete Confirmation -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this student?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">Delete</button>
            </div>
        </div>
    </div>
</div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
<!-- Modal for Random Student Selection -->
<div class="modal fade random-modal" id="randomStudentModal" tabindex="-1" role="dialog" aria-labelledby="randomStudentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header text-center">
                <h5 class="modal-title bi bi-emoji-wink-fill " id="randomStudentModalLabel"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body ">
                <div class="countdown " id="countdown">3</div>
                <div class="student-info" id="studentInfo"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    let studentIdToDelete = 0;

    function confirmDelete(studentId) {
        studentIdToDelete = studentId;
        $('#deleteModal').modal('show');
    }

    $('#confirmDeleteButton').click(function () {
        $.ajax({
            url: '/Admin/Students/DeleteStudent',
            type: 'POST',
            data: { id: studentIdToDelete },
            success: function (response) {
                if (response.success) {
                    $('#deleteModal').modal('hide');
                    location.reload();
                }
            },
            error: function () {
                alert('Error deleting student.');
            }
        });
    });

    function searchSchools() {
        var input, filter, table, rows, td, i, txtValue;
        input = document.getElementById("searchInput");
        filter = input.value.toUpperCase();
        table = document.getElementById("dataTable");
        rows = table.getElementsByTagName("tr");

        for (i = 1; i < rows.length; i++) {
            td = rows[i].getElementsByTagName("td");
            if (td) {
                var nameColumn = td[1];  // Name column
                var lastNameColumn = td[2];  // LastName column

                var match = false;
                if (nameColumn) {
                    txtValue = nameColumn.textContent || nameColumn.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        match = true;
                    }
                }
                if (lastNameColumn) {
                    txtValue = lastNameColumn.textContent || lastNameColumn.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        match = true;
                    }
                }

                if (match) {
                    $(rows[i]).fadeIn(300);  // Show row with animation
                } else {
                    $(rows[i]).fadeOut(300);  // Hide row with animation
                }
            }
        }
    }

    function selectRandomStudent() {
        // Get all table rows
        const rows = document.querySelectorAll('#schoolsTableBody tr');
        if (rows.length === 0) {
            alert('No students available to select.');
            return;
        }

        // Random selection of a row
        const randomIndex = Math.floor(Math.random() * rows.length);
        const selectedRow = rows[randomIndex];
        const name = selectedRow.querySelector('td:nth-child(2)').textContent;
        const lastName = selectedRow.querySelector('td:nth-child(3)').textContent;

        // Reset modal
        const countdownElement = document.getElementById('countdown');
        const studentInfoElement = document.getElementById('studentInfo');
        countdownElement.style.display = 'block';
        countdownElement.classList.remove('fade-in');
        studentInfoElement.style.display = 'none';
        studentInfoElement.innerHTML = '';
        countdownElement.textContent = '5';

        // Show modal
        $('#randomStudentModal').modal('show');

        // Countdown
        let count = 5;
        const countdownInterval = setInterval(() => {
            count--;
            if (count >= 0) {
                countdownElement.textContent = count;
                countdownElement.classList.remove('fade-in');
                void countdownElement.offsetWidth; // Restart animation
                countdownElement.classList.add('fade-in');
            } else {
                clearInterval(countdownInterval);
                countdownElement.style.display = 'none';
                studentInfoElement.innerHTML = `<strong></strong><br>${name} ${lastName}`;
                studentInfoElement.style.display = 'block';
                studentInfoElement.classList.add('fade-in');
            }
        }, 1000);
    }
</script>